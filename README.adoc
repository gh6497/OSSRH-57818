= swagger注解的扩展
:source-highlighter: highlightjs

接口的响应并不总是复杂的，可能又是需要返回一个资源id，如果新建一个类，这个类只有一个属性有点没必要，如果返回map，swagger不能内省响应信息。本项目采用javaassit库运行时动态生成JavaBean类，帮助swagger完成内省

== 用法

.Application.java
[source,java]
----
package cn.len.swagger.extension;

import com.github.length.swagger.extension.annotation.ApiJsonObject;
import com.github.length.swagger.extension.annotation.ApiJsonObjects;
import com.github.length.swagger.extension.annotation.ApiJsonProperty;
import com.github.length.swagger.extension.plugin.ApiJsonOperationModelsProviderPlugin;
import com.github.length.swagger.extension.plugin.ParameterPlugin;
import com.github.length.swagger.extension.plugin.ResponsePlugin;
import com.fasterxml.classmate.TypeResolver;
import io.swagger.annotations.ApiModelProperty;
import io.swagger.annotations.ResponseHeader;
import lombok.*;
import lombok.experimental.FieldDefaults;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.core.annotation.Order;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.builders.RequestHandlerSelectors;
import springfox.documentation.schema.TypeNameExtractor;
import springfox.documentation.schema.WildcardType;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger.common.SwaggerPluginSupport;
import springfox.documentation.swagger2.annotations.EnableSwagger2;

import java.util.Collections;
import java.util.Map;

import static springfox.documentation.schema.AlternateTypeRules.newRule;

@SpringBootApplication
@EnableSwagger2
@RequiredArgsConstructor
@FieldDefaults(makeFinal = true, level = AccessLevel.PRIVATE)
@RestController
@RequestMapping("/test")
public class ExtensionApplication {

    public static void main(String[] args) {
        SpringApplication.run(ExtensionApplication.class, args);
    }

    @GetMapping("/parameter")
    public void testParameter(
        @RequestBody
        @ApiJsonObject(name = "Parameter", properties =
            {
                @ApiJsonProperty(name = "username"),
                @ApiJsonProperty(name = "name", clazz = TestBean.class)
            })
            Map<String, Object> stringObjectMap) {

    }

    @ApiJsonObject(name = "ReturnType", properties =
        {
            @ApiJsonProperty(name = "username"),
            @ApiJsonProperty(name = "age", clazz = Integer.class),
            @ApiJsonProperty(name = "name", clazz = TestBean.class)
        })
    @GetMapping("/return-type")
    public Map<String, Object> returnType() {

        return Collections.EMPTY_MAP;
    }


    @GetMapping("entity")
    public ResponseEntity<TestBean> entity() {
        val testBean = new TestBean();
        testBean.setUsername("username");
        return ResponseEntity.ok(testBean);
    }


    @GetMapping("/parameter-return-type")
    public Map<String, Object> parameterReturnType(@RequestBody Map<String, Object> stringObjectMap) {
        return Collections.EMPTY_MAP;
    }


    @ApiJsonObjects(
        {
            @ApiJsonObject(name = "Objects1", properties = {@ApiJsonProperty(name = "username1")}, code = 400,
                responseHeaders = {@ResponseHeader(name = "hhh", response = String.class)}, message = "Bad Request"),
            @ApiJsonObject(name = "Objects2", properties = {@ApiJsonProperty(name = "username2")}, code = 401)}
    )
    @ApiJsonObject(name = "Objects0", properties =
        {
            @ApiJsonProperty(name = "username"),
            @ApiJsonProperty(name = "name", clazz = TestBean.class)
        })
    @GetMapping("/api-json-objects")
    public Map<String, Object> apiJsonObjects() {
        return Collections.EMPTY_MAP;
    }


    @GetMapping("base-response")
    public BaseResponse<TestBean> baseResponse() {
        val testBeanBaseResponse = new BaseResponse<TestBean>();
        val data = new TestBean();
        data.setUsername("username");
        testBeanBaseResponse.setData(data);
        return testBeanBaseResponse;
    }


    private ApiInfo apiInfo() {
        return new ApiInfoBuilder()
            .title("swagger-extension")
            .contact(new Contact("len.cai", "https://blog.csdn.net/csdn6497", "len.cai@yunlsp.com"))
            .version("1.0")
            .description("swagger-extension")
            .build();
    }

    @Bean
    public Docket docket(TypeResolver typeResolver) {

        return new Docket(DocumentationType.SWAGGER_2)
            .select()
            .apis(RequestHandlerSelectors.basePackage("cn.len.swagger.extension"))
            .paths(PathSelectors.any())
            .build()
            .useDefaultResponseMessages(false)
            .alternateTypeRules(newRule(typeResolver.resolve(BaseResponse.class, WildcardType.class),
                typeResolver.resolve(WildcardType.class)))
            .apiInfo(apiInfo());
    }


    @Order(SwaggerPluginSupport.SWAGGER_PLUGIN_ORDER + 1000)
    @Bean
    public ResponsePlugin responsePlugin(TypeNameExtractor typeNameExtractor) {
        return new ResponsePlugin(typeNameExtractor);
    }

    @Bean
    public ApiJsonOperationModelsProviderPlugin apiJsonOperationModelsProviderPlugin(TypeResolver typeResolver) {
        return new ApiJsonOperationModelsProviderPlugin(typeResolver, new ClassCreator());
    }

    @Order(SwaggerPluginSupport.SWAGGER_PLUGIN_ORDER + 1000)
    @Bean
    public ParameterPlugin parameterPlugin(TypeNameExtractor typeNameExtractor) {
        return new ParameterPlugin(typeNameExtractor);
    }

    @Getter
    @Setter
    @ToString
    @FieldDefaults(level = AccessLevel.PRIVATE)
    public static class TestBean {
        @ApiModelProperty(value = "用户名", required = true)
        String username;
    }

}

----


